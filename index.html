<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>斯大林格勒：钢铁战线指挥图</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.4/lib/p5.min.js"></script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #17140f;
      --bg-2: #1f1b15;
      --panel: rgba(27, 23, 18, 0.86);
      --panel-2: rgba(17, 14, 11, 0.9);
      --line: #8b7548;
      --line-2: #4c3f27;
      --text: #d8cfb7;
      --sub: #a79b7c;
      --axis: #d9be74;
      --sov: #d07f72;
      --ok: #8bb06a;
      --warn: #be5a4c;
      --scan: rgba(255, 240, 198, 0.045);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background:
        radial-gradient(circle at 18% -8%, #3a3120 0%, rgba(58, 49, 32, 0) 45%),
        radial-gradient(circle at 88% 12%, #3a2a1f 0%, rgba(58, 42, 31, 0) 34%),
        linear-gradient(180deg, var(--bg-2), var(--bg));
      color: var(--text);
      font-family: "Courier New", "Consolas", "Lucida Console", "Noto Sans SC", monospace;
      overflow: hidden;
      overscroll-behavior: none;
      letter-spacing: 0.2px;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        repeating-linear-gradient(180deg, transparent 0, transparent 3px, var(--scan) 3px, var(--scan) 4px),
        repeating-linear-gradient(90deg, rgba(255, 235, 190, 0.018) 0, rgba(255, 235, 190, 0.018) 1px, transparent 1px, transparent 6px);
      z-index: 20;
      mix-blend-mode: soft-light;
    }
    canvas {
      display: block;
      touch-action: none;
      filter: saturate(0.92) contrast(1.04);
    }

    .panel {
      pointer-events: auto;
      background:
        linear-gradient(180deg, rgba(255, 221, 159, 0.06), rgba(0, 0, 0, 0)),
        linear-gradient(165deg, var(--panel), var(--panel-2));
      border: 1px solid var(--line);
      box-shadow:
        inset 0 0 0 1px rgba(255, 214, 127, 0.08),
        0 10px 24px rgba(0, 0, 0, 0.42);
      border-radius: 2px;
      overflow: hidden;
    }

    #topDock {
      position: fixed;
      top: calc(8px + env(safe-area-inset-top));
      left: 10px;
      right: 10px;
      z-index: 7;
      padding: 8px 10px;
      display: grid;
      gap: 8px;
      pointer-events: auto;
    }
    .topTitleRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      min-width: 0;
    }
    #scenarioTitle {
      font-size: 14px;
      font-weight: 700;
      color: #e8d8b6;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .tag {
      padding: 2px 8px;
      border-radius: 2px;
      font-size: 11px;
      border: 1px solid #6f5f3f;
      background: rgba(70, 57, 35, 0.7);
      color: #ead9b0;
      white-space: nowrap;
    }
    .topControls {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
    }
    .topControls label {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #d7c6a3;
    }
    select {
      padding: 6px 8px;
      border-radius: 2px;
      border: 1px solid #7f6940;
      background: #1e1812;
      color: var(--text);
      font-family: inherit;
      font-size: 12px;
    }

    #ui {
      --panel-width: min(274px, 23vw);
      position: fixed;
      inset: 0;
      pointer-events: none;
      display: grid;
      grid-template-columns: var(--panel-width) 1fr var(--panel-width);
      grid-template-rows: 1fr auto;
      gap: 8px;
      padding: calc(84px + env(safe-area-inset-top)) 10px calc(10px + env(safe-area-inset-bottom));
      z-index: 5;
    }
    body.compact-ui #ui {
      --panel-width: min(238px, 20vw);
      gap: 7px;
    }
    #leftPanel, #rightPanel {
      padding: 10px;
      overflow: auto;
      scrollbar-color: #6f5c37 #1b1712;
    }
    #rightPanel { grid-column: 3; }
    #bottomBar {
      grid-column: 1 / span 3;
      display: grid;
      grid-template-columns: repeat(8, minmax(70px, 1fr));
      gap: 6px;
      padding: 6px;
      background:
        linear-gradient(180deg, rgba(223, 179, 102, 0.1), rgba(0, 0, 0, 0)),
        rgba(14, 12, 9, 0.9);
      border-top: 1px solid var(--line);
    }

    body.hide-left-panel #leftPanel { display: none; }
    body.hide-left-panel #ui { grid-template-columns: 1fr var(--panel-width); }
    body.hide-left-panel #rightPanel { grid-column: 2; }
    body.hide-left-panel #bottomBar { grid-column: 1 / span 2; }

    body.hide-right-panel #rightPanel { display: none; }
    body.hide-right-panel #ui { grid-template-columns: var(--panel-width) 1fr; }
    body.hide-right-panel #bottomBar { grid-column: 1 / span 2; }

    body.hide-left-panel.hide-right-panel #ui { grid-template-columns: 1fr; }
    body.hide-left-panel.hide-right-panel #bottomBar { grid-column: 1; }

    body.map-focus #leftPanel,
    body.map-focus #rightPanel { display: none !important; }
    body.map-focus #ui { grid-template-columns: 1fr !important; }
    body.map-focus #bottomBar { grid-column: 1 !important; }

    .btn {
      border: 1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(223, 179, 102, 0.24), rgba(68, 52, 28, 0.3)),
        linear-gradient(180deg, #2f2719, #241d14);
      color: var(--text);
      border-radius: 2px;
      padding: 6px 8px;
      min-height: 38px;
      cursor: pointer;
      pointer-events: auto;
      font-family: inherit;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      touch-action: manipulation;
      transition: filter .14s, transform .12s, box-shadow .12s;
      box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.4);
    }
    .btn.mini {
      min-height: 30px;
      padding: 4px 8px;
      font-size: 11px;
      text-transform: none;
      letter-spacing: 0.3px;
    }
    .btn:hover { filter: brightness(1.1); }
    .btn:active { transform: translateY(1px); }
    .btn.active {
      border-color: #ceb06b;
      box-shadow:
        0 0 0 1px rgba(232, 198, 106, 0.5),
        inset 0 0 0 1px rgba(255, 232, 179, 0.28);
    }
    .btn.warn {
      border-color: #a4554e;
      background:
        linear-gradient(180deg, rgba(208, 127, 114, 0.32), rgba(92, 43, 38, 0.36)),
        linear-gradient(180deg, #3a211d, #271613);
    }

    h2 {
      margin: 0 0 8px;
      font-size: 16px;
      line-height: 1.15;
      text-transform: uppercase;
      letter-spacing: 0.7px;
    }
    h3 {
      margin: 10px 0 6px;
      font-size: 13px;
      color: #ccb17a;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }
    .muted {
      color: var(--sub);
      font-size: 12px;
      line-height: 1.45;
    }
    .stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px dashed rgba(203, 173, 113, 0.23);
      padding: 5px 0;
      font-size: 12px;
      gap: 8px;
    }
    .stat span:first-child {
      color: #cbb88e;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      flex: 1;
    }
    .stat span:last-child {
      color: #e7dcc2;
      text-align: right;
      font-weight: 700;
    }
    .log {
      max-height: 248px;
      overflow: auto;
      font-size: 12px;
      line-height: 1.45;
      padding-right: 4px;
      scrollbar-color: #6f5c37 #1b1712;
    }
    .log div {
      border-left: 2px solid #6e5a35;
      padding-left: 8px;
      margin: 6px 0;
      color: #d6c9ad;
    }
    .titleSide-GER { color: var(--axis); }
    .titleSide-SOV { color: var(--sov); }

    #startOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(10, 8, 6, 0.86);
      z-index: 12;
      backdrop-filter: blur(3px);
    }
    .card {
      width: min(94vw, 660px);
      background:
        linear-gradient(180deg, rgba(227, 191, 119, 0.09), rgba(0, 0, 0, 0)),
        #1a1510;
      border: 1px solid var(--line);
      border-radius: 2px;
      box-shadow:
        inset 0 0 0 1px rgba(247, 220, 164, 0.08),
        0 12px 48px rgba(0, 0, 0, 0.45);
      padding: 16px;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0;
    }

    #mobileToggles {
      position: fixed;
      top: calc(8px + env(safe-area-inset-top));
      right: 8px;
      z-index: 9;
      display: none;
      gap: 8px;
      pointer-events: auto;
    }
    #mobileToggles .btn {
      min-width: 74px;
      min-height: 34px;
      padding: 5px 8px;
      font-size: 11px;
    }

    @media (max-width: 1220px) {
      #ui {
        --panel-width: min(250px, 25vw);
      }
    }

    @media (max-width: 1100px) {
      #topDock {
        left: 8px;
        right: 8px;
        padding: 6px 8px;
      }
      #ui {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr;
        padding: calc(86px + env(safe-area-inset-top)) 8px calc(8px + env(safe-area-inset-bottom));
      }
      #leftPanel, #rightPanel {
        display: none;
        position: fixed;
        left: 8px;
        right: 8px;
        bottom: calc(126px + env(safe-area-inset-bottom));
        max-height: 48vh;
        z-index: 8;
      }
      body.mobile-show-left #leftPanel,
      body.mobile-show-right #rightPanel {
        display: block;
      }
      #bottomBar {
        position: fixed;
        left: 8px;
        right: 8px;
        bottom: calc(8px + env(safe-area-inset-bottom));
        grid-column: 1;
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
      #mobileToggles { display: flex; }
      .btn { font-size: 11px; }
      .topControls .btn.mini {
        min-height: 28px;
        padding: 3px 6px;
      }
      .topControls label {
        width: 100%;
      }
      .topControls select {
        flex: 1;
      }
    }

    @media (max-width: 760px) and (orientation: portrait) {
      #mobileToggles {
        left: 8px;
        right: 8px;
        top: calc(8px + env(safe-area-inset-top));
        justify-content: space-between;
      }
      #mobileToggles .btn {
        flex: 1;
        min-width: 0;
      }
      #leftPanel, #rightPanel {
        bottom: calc(178px + env(safe-area-inset-bottom));
        max-height: 54vh;
      }
      #bottomBar {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 6px;
        padding: 6px;
      }
      #bottomBar .btn {
        min-height: 44px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body class="compact-ui">
  <div id="startOverlay">
    <div class="card">
      <h2>斯大林格勒：钢铁战线指挥图</h2>
      <p id="scenarioBriefing" class="muted">战区简报加载中...</p>
      <div class="row">
        <label>战役场景
          <select id="pickScenario"></select>
        </label>
        <label>玩家阵营
          <select id="pickSide">
            <option value="GER">德军（先手）</option>
            <option value="SOV">苏军</option>
          </select>
        </label>
        <label>AI 难度
          <select id="pickDiff">
            <option value="normal">正常</option>
            <option value="hard">困难</option>
          </select>
        </label>
      </div>
      <button id="startBtn" class="btn">进入指挥席</button>
    </div>
  </div>

  <div id="topDock" class="panel">
    <div class="topTitleRow">
      <div id="scenarioTitle">战役载入中</div>
      <span class="tag" id="scenarioMeta">地图载入中</span>
    </div>
    <div class="topControls">
      <label>快速切换战役
        <select id="scenarioQuick"></select>
      </label>
      <button class="btn mini" id="btnScenarioApply">载入战役</button>
      <button class="btn mini active" id="btnCompact">紧凑UI</button>
      <button class="btn mini" id="btnFocusMap">地图聚焦</button>
      <button class="btn mini active" id="btnToggleWar">战况窗</button>
      <button class="btn mini active" id="btnToggleUnits">单位窗</button>
    </div>
  </div>

  <div id="mobileToggles">
    <button class="btn" id="btnPanelLeft">战况</button>
    <button class="btn" id="btnPanelRight">单位</button>
    <button class="btn" id="btnFit">居中</button>
  </div>

  <div id="ui">
    <aside id="leftPanel" class="panel"></aside>
    <aside id="rightPanel" class="panel"></aside>
    <footer id="bottomBar" class="panel">
      <button class="btn active" data-mode="MOVE">机动</button>
      <button class="btn" data-mode="ATTACK">突击</button>
      <button class="btn" data-mode="BOMBARD">火力</button>
      <button class="btn" data-mode="FORTIFY">筑垒</button>
      <button class="btn" id="btnSupply">补给</button>
      <button class="btn" id="btnCenter">定位单位</button>
      <button class="btn warn" id="btnEnd">回合结束</button>
      <button class="btn" id="btnRestart">重置战区</button>
    </footer>
  </div>

  <script src="./data/map_scenarios.js"></script>
  <script src="./data/unit_scenarios.js"></script>
  <script src="./app.js"></script>
</body>
</html>
